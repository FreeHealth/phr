/* Do not edit this file directly.  Edit the template in auto_inc_sql.rake,
   and re-run rake def:generate_auto_inc_sql. */
DROP PROCEDURE IF EXISTS reset_auto_increment;
DELIMITER $$
CREATE DEFINER = CURRENT_USER PROCEDURE reset_auto_increment()
BEGIN
  DECLARE auto_inc_count INT;
  DECLARE stored_auto_increment INT;
  DECLARE max_id INT;
  SET auto_inc_count = 0;
  SELECT count(*) FROM auto_increments WHERE table_name='obr_orders' INTO auto_inc_count;
  IF auto_inc_count != 0 THEN
    SELECT min_auto_increment FROM auto_increments WHERE table_name='obr_orders' INTO stored_auto_increment;
    SELECT max(id) FROM obr_orders INTO max_id;
    IF max_id < stored_auto_increment THEN
      /* ALTER TABLE will not let you use a variable for auto_increment, so we have build the
       * statement using concat. */
      SET @alter_table_sql = CONCAT("ALTER TABLE obr_orders AUTO_INCREMENT =", stored_auto_increment);
      PREPARE stmt FROM @alter_table_sql; 
      EXECUTE stmt; 
      DEALLOCATE PREPARE stmt;
    END IF;
  END IF;
  SET auto_inc_count = 0;
  SELECT count(*) FROM auto_increments WHERE table_name='users' INTO auto_inc_count;
  IF auto_inc_count != 0 THEN
    SELECT min_auto_increment FROM auto_increments WHERE table_name='users' INTO stored_auto_increment;
    SELECT max(id) FROM users INTO max_id;
    IF max_id < stored_auto_increment THEN
      /* ALTER TABLE will not let you use a variable for auto_increment, so we have build the
       * statement using concat. */
      SET @alter_table_sql = CONCAT("ALTER TABLE users AUTO_INCREMENT =", stored_auto_increment);
      PREPARE stmt FROM @alter_table_sql; 
      EXECUTE stmt; 
      DEALLOCATE PREPARE stmt;
    END IF;
  END IF;
  SET auto_inc_count = 0;
  SELECT count(*) FROM auto_increments WHERE table_name='profiles' INTO auto_inc_count;
  IF auto_inc_count != 0 THEN
    SELECT min_auto_increment FROM auto_increments WHERE table_name='profiles' INTO stored_auto_increment;
    SELECT max(id) FROM profiles INTO max_id;
    IF max_id < stored_auto_increment THEN
      /* ALTER TABLE will not let you use a variable for auto_increment, so we have build the
       * statement using concat. */
      SET @alter_table_sql = CONCAT("ALTER TABLE profiles AUTO_INCREMENT =", stored_auto_increment);
      PREPARE stmt FROM @alter_table_sql; 
      EXECUTE stmt; 
      DEALLOCATE PREPARE stmt;
    END IF;
  END IF;
END$$
DELIMITER ;
