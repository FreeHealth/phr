/* Do not edit this file directly.  Edit the template in auto_inc_sql.rake,
   and re-run rake def:generate_auto_inc_sql. */
DROP TRIGGER IF EXISTS maintain_max_id_after_delete_on_users;
DELIMITER $$
CREATE DEFINER = CURRENT_USER TRIGGER maintain_max_id_after_delete_on_users
BEFORE DELETE on users
FOR EACH ROW
BEGIN
  DECLARE max_id INT;
  DECLARE auto_rec_count INT;
  DECLARE stored_auto_inc_val INT;
  DECLARE new_auto_inc_val INT;
  SELECT max(id) INTO max_id FROM users;
  IF OLD.id = max_id THEN
    SET new_auto_inc_val = max_id + 1;
    /* Look for the auto_increments record */
    SELECT count(*) FROM auto_increments WHERE table_name='users' INTO auto_rec_count; 
    IF auto_rec_count != 0 THEN
      SELECT min_auto_increment from auto_increments WHERE table_name='users' INTO stored_auto_inc_val;
      IF new_auto_inc_val > stored_auto_inc_val THEN
        UPDATE auto_increments SET min_auto_increment=new_auto_inc_val WHERE table_name='users';
      END IF;
    ELSE
      INSERT INTO auto_increments SET table_name='users', min_auto_increment=new_auto_inc_val;
    END IF;
  END IF;
END;
$$
DELIMITER ;
