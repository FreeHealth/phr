| open | /accounts/logout |

| waitForTextPresent | Loaded in |
| pause | 200 |

| fireEvent | fe_user_name_1_1 | focus |
| waitForExpression | javascript{testWindow_.Def.Navigation.focusedField_ == 'fe_user_name_1_1'} | true |
| type | fe_user_name_1_1 | test_admi |
| typeKeys | fe_user_name_1_1 | n |
| pause | 200 |
| fireEvent | fe_user_name_1_1 | change |
| fireEvent | fe_user_name_1_1 | blur |

| fireEvent | fe_password_1_1 | focus |
| waitForExpression | javascript{testWindow_.Def.Navigation.focusedField_ == 'fe_password_1_1'} | true |
| type | fe_password_1_1 | I'm a test admin accoun |
| typeKeys | fe_password_1_1 | t |
| pause | 200 |
| fireEvent | fe_password_1_1 | change |
| fireEvent | fe_password_1_1 | blur |

| pause | 200 |
| waitForExpression | javascript{testWindow_.createCookie('phr_user', '3f0df575eda55d1b0bf59d23613d7a6e02723bc8a8dabe709876e3a1ca0afb81',365); true} | true |

| pause | 500 |
| waitForExpression | javascript{testWindow_.readCookie('phr_user');} | 3f0df575eda55d1b0bf59d23613d7a6e02723bc8a8dabe709876e3a1ca0afb81 |

| pause | 200 |
| click | fe_login_1_1 |
| waitForExpression | javascript{testWindow_.location.href} | */admin_home |

| open | /phr_home |
| setTimeout | 35000 |

| waitForExpression | javascript{testWindow_.location.href} | */phr_home* |
| waitForVisible | add_new |

| click | add_new |
| waitForVisible | fe_demographics_1_0 |
| waitForExpression | javascript{Def.PhrHomeTest.verifyDialogBoxTitle(testWindow_.Def.PHRHome.demographicsDialog_, testWindow_.Def.PHRHome.DEMOGRAPHICS_DIALOG_NEW_TITLE)} | true |


# Create a profile that we can use for the rest of the test
| fireEvent | fe_pseudonym_1_1 | focus |
| waitForExpression | javascript{testWindow_.Def.Navigation.focusedField_ == 'fe_pseudonym_1_1'} | true |
| type | fe_pseudonym_1_1 | javascript{'phr_rules1_'+new Date().getTime()} |
| fireEvent | fe_pseudonym_1_1 | change |
| fireEvent | fe_pseudonym_1_1 | blur |

| fireEvent | fe_birth_date_1_1 | focus |
#| type | fe_birth_date_1_1 | 200 |
#| typeKeys | fe_birth_date_1_1 | 9 |
| type | fe_birth_date_1_1 | t-30 |
| typeKeys | fe_birth_date_1_1 | y |
| keyDown | fe_birth_date_1_1 | \9 |
| fireEvent | fe_birth_date_1_1 | change |
| fireEvent | fe_birth_date_1_1 | blur |


| fireEvent | fe_gender_1_1 | focus |
| waitForExpression | javascript{testWindow_.Def.Navigation.focusedField_ == 'fe_gender_1_1'} | true |
| selectByContent | fe_gender_1_1 | Female |
| fireEvent | fe_gender_1_1 | change |
| fireEvent | fe_gender_1_1 | blur |
| waitForValue | fe_gender_C_1_1 | F |

# Save the profile
| click | editSaveBtn |
| waitForExpression | javascript{testWindow_.location.href} | *;edit |
| waitForTextPresent | Loaded in |

# Open up the form
| waitForVisible | fe_expcol_all |
| click | css=div#fe_expcol_all > span:first-child |

# Test the reminders generated by server side javascript engine
# Back up the current href
| storeExpression | javascript{testWindow_.location.href;} | mainPageHref |
# Send request to get server side reminders
| waitForExpression | javascript{testWindow_.location.href = storedVars['mainPageHref'].gsub(/;edit/,"/reminders").gsub(/profiles/,"phr_records"); true} | true |
# Confirm the expected reminder message
| waitForExpression | javascript{testWindow_.document.body.innerHTML.indexOf("Tetanus booster")>-1;} | true |
# Reload the PHR main page in standard mode 
| waitForExpression | javascript{testWindow_.location.href = storedVars['mainPageHref'];true} | true |
| waitForEditable | fe_reminders_1_1 |

# Open up the form again
| waitForVisible | fe_expcol_all |
| click | css=div#fe_expcol_all > span:first-child |

| waitForExpression | javascript{testWindow_.$("fe_reminders_1_1").messageManager.getAllMessages().join("").indexOf("Colon Cancer Screening")==-1;} | true |
# (We used to test for the colon cancer screening reminder here but we don't
# currently have that.)
# Test the hiding of inactive saved drugs.
| waitForVisible | fe_name_and_route_1 |
| fireEvent | fe_name_and_route_1 | focus |
| selectByContent | fe_name_and_route_1 | Aspirin EC (Oral Pill) |
| fireEvent | fe_name_and_route_1 | blur |
| click | fe_drug_use_status_1 |
| waitForExpression | javascript{!testWindow_.isHiddenOrDisabled(testWindow_.$('completionOptions'))} | true |
| waitForExpression | javascript{testWindow_.$('completionOptions').down().childNodes.length} | 2 |
| selectByIndex | fe_drug_use_status_1 | 0 |
| keyDown | fe_drug_use_status_1 | \9 |
| waitForValue | fe_drug_use_status_1 | Active |
| fireEvent | fe_drug_use_status_1 | blur |
| click | fe_name_and_route_2 |
| selectByContent | fe_name_and_route_2 | TYLENOL (Oral Pill) |
| click | fe_drug_use_status_2 |
| waitForExpression | javascript{!testWindow_.isHiddenOrDisabled(testWindow_.$('completionOptions'))} | true |
| selectByIndex | fe_drug_use_status_2 | 1 |
| waitForValue | fe_drug_use_status_C_2 | DRG-I |
| waitForVisible | fe_name_and_route_3 |
| verifyVisible | fe_name_and_route_1 |
| verifyVisible | fe_name_and_route_2 |
# (show all)
| click | fe_inactive_drugs |
# (hide inactive)
| click | fe_inactive_drugs |
| verifyVisible | fe_name_and_route_1 |
#| assertNotVisible | fe_name_and_route_2 |  # newly added records are always visible
| verifyVisible | fe_name_and_route_3 |
# Save these two drug records, and then test the Show All checkbox.
| click | fe_save_1 |
| waitForVisible | saved_notice |
| verifyExpression | javascript{testWindow_.location.reload(); 1} | 1 |
| waitForVisible | loading_msg |
| waitForNotVisible | loading_msg |

# Open up the form again
| waitForVisible | fe_expcol_all |
| click | css=div#fe_expcol_all > span:first-child |

| assertNotVisible | fe_name_and_route_2 |
| click | fe_inactive_drugs |
| verifyVisible | fe_name_and_route_1 |
| waitForVisible | fe_name_and_route_2 |
| verifyVisible | fe_name_and_route_3 |
| click | fe_inactive_drugs |
| verifyVisible | fe_name_and_route_1 |
| waitForNotVisible | fe_name_and_route_2 |
| verifyVisible | fe_name_and_route_3 |

# Some rules (e.g. has_allergy_url) will be triggered after clicking the save button on PHR form
# if a related record (e.g. allergy record) was added or edited
| click | fe_allergy_name_1 |
| waitForExpression | javascript{!testWindow_.isHiddenOrDisabled(testWindow_.$('completionOptions'))} | true |
| waitForExpression | javascript{testWindow_.$('completionOptions').down().childNodes.length } | 16 |
| selectByIndex | fe_allergy_name_1 | 25 |
| keyDown | fe_allergy_name_1 | \9 |
| waitForValue | fe_allergy_name_1 | Dust Mites |
| fireEvent | fe_allergy_name_1 | blur |
| waitForVisible | fe_allergy_info_1 |

| click | fe_allergy_name_2 |
| waitForExpression | javascript{!testWindow_.isHiddenOrDisabled(testWindow_.$('completionOptions'))} | true |
| waitForExpression | javascript{testWindow_.$('completionOptions').down().childNodes.length } | 16 |
| selectByIndex | fe_allergy_name_2 | 26 |
| keyDown | fe_allergy_name_2 | \9 |
| waitForValue | fe_allergy_name_2 | Hay Fever |
| fireEvent | fe_allergy_name_2 | blur |
| waitForVisible | fe_allergy_info_2 |

| click | fe_save_1 |
| waitForVisible | savingNotice |
| waitForVisible | saved_notice |
| waitForVisible | fe_allergy_info_1 |
| waitForVisible | fe_allergy_info_2 |

# Set today's date to a fixed value so the tests are not dependent on the
# current date.
| verifyExpression | javascript{testWindow_.Def.Rules.RuleFunctions.today = function() {return new Date('11/1/2009')}; 1 } | 1 |
| type | fe_birth_date | 1950 |
| fireEvent | fe_birth_date | change |

# Now check for an autocompleter field
# (We're not really testing that, because on the
# PHR form the gender field is a hidden field, not an autocompleter.)
| type | fe_gender | Female |
| fireEvent | fe_gender | change |
| type | fe_gender_C | F |
| fireEvent | fe_gender_C | change |
| type | fe_birth_date | 1984 |
| fireEvent | fe_birth_date | change |
| waitForVisible | fe_pregnant_1 |
| waitForNotVisible | fe_abdominal_ultra_1_0 |
| type | fe_gender | Male |
| fireEvent | fe_gender | change |
| type | fe_gender_C | M |
| fireEvent | fe_gender_C | change |
| waitForNotVisible | fe_pregnant_1 |
# (fe_tp1_loinc_panel_temp_1_6_0 = Abdominal Ultrasound)
| waitForNotVisible | fe_tp1_loinc_panel_temp_1_6_0 |
| type | fe_birth_date | 1942 |
| fireEvent | fe_birth_date | change |
| waitForVisible | fe_tp1_loinc_panel_temp_1_6_0 |
| waitForVisible | fe_problem_1 |
| selectByContent | fe_problem_1 | Headache |
| waitForVisible | fe_mplus_health_topics_1 |
| waitForEditable | fe_reminders_1_1 |
# (We used to test the cases of the flu shot rule here, but that has been
# deleted and the new one is still in progress.)
#| waitForExpression | javascript{testWindow_.$("fe_reminders_1_1").messageManager.getAllMessages().join("").indexOf("older than 50 unless they are allergic to the vaccine")>-1;} | true |
#| click | fe_reminders_1_1 |
#| verifyExpression | javascript{window.focus(); true;} | true |
#| verifyExpression | javascript{testWindow_.Def.lastPopupWindow_.close(); true;} | true |
#| type | fe_birth_date_1 | 1991 |
#| fireEvent | fe_birth_date_1 | change |
#| waitForEditable | fe_reminders_1_1 |
#| waitForExpression | javascript{testWindow_.$("fe_reminders_1_1").messageManager.getAllMessages().join("").indexOf("age of 0.5 and 19 unless they are allergic")>-1;} | true |
#| click | fe_reminders_1_1 |
#| verifyExpression | javascript{window.focus(); true;} | true |
#| verifyExpression | javascript{testWindow_.Def.lastPopupWindow_.close(); true;} | true |
#| type | fe_birth_date_1 | 1970 |
#| fireEvent | fe_birth_date_1 | change |
#| waitForExpression | javascript{testWindow_.$("fe_reminders_1_1").messageManager.getAllMessages().join("").indexOf("age of 0.5 and 19 unless they are allergic") == -1;} | true |
| type | fe_birth_date | 1950 |
| fireEvent | fe_birth_date | change |
#| selectByIndex | fe_smoke_1 | 0 |
#| fireEvent | fe_smoke_1 | change |
#| fireEvent | fe_smoke_1 | blur |
#| selectByIndex | fe_high_bp_treated_1 | 1 |
#| fireEvent | fe_high_bp_treated_1 | change |
#| fireEvent | fe_high_bp_treated_1 | blur |
| type | fe_tp1_panel_testdate_1_9_1 | 2009 May 22 |
| fireEvent | fe_tp1_panel_testdate_1_9_1 | change |
| selectByIndex | fe_tp1_test_value_1_9_1_1 | 0 |
| fireEvent | fe_tp1_test_value_1_9_1_1 | change |
| fireEvent | fe_tp1_test_value_1_9_1_1 | blur |
| selectByIndex | fe_tp1_test_value_1_9_1_2 | 1 |
| fireEvent | fe_tp1_test_value_1_9_1_2 | change |
| fireEvent | fe_tp1_test_value_1_9_1_2 | blur |
| type | fe_tp1_panel_testdate_1_1_1 | 2009 May 22 |
| fireEvent | fe_tp1_panel_testdate_1_1_1 | change |
| fireEvent | fe_tp1_panel_testdate_1_1_1 | blur |
| type | fe_tp1_test_value_1_1_1_1 | 110 |
| fireEvent | fe_tp1_test_value_1_1_1_1 | change |
| fireEvent | fe_tp1_test_value_1_1_1_1 | blur |
| type | fe_tp1_panel_testdate_1_3_1 | 2009 May 22 |
| fireEvent | fe_tp1_panel_testdate_1_3_1 | change |
| fireEvent | fe_tp1_panel_testdate_1_3_1 | blur |
| type | fe_tp1_test_value_1_3_1_1 | 180 |
| fireEvent | fe_tp1_test_value_1_3_1_1 | change |
| fireEvent | fe_tp1_test_value_1_3_1_1 | blur |
| type | fe_tp1_test_value_1_3_1_2 | 160 |
| fireEvent | fe_tp1_test_value_1_3_1_2 | change |
| fireEvent | fe_tp1_test_value_1_3_1_2 | blur |
| waitForEditable | fe_reminders_1_1 |
| waitForExpression | javascript{testWindow_.$("fe_reminders_1_1").messageManager.getAllMessages().join("").indexOf("Your framingham 10-year heart risk is 2%")>-1;} | true |
| type | fe_gender | Female |
| fireEvent | fe_gender | change |
| type | fe_gender_C | F |
| fireEvent | fe_gender_C | change |
| type | fe_birth_date | 1950 |
| fireEvent | fe_birth_date | change |

# Risk Factors
| type | fe_tp1_panel_testdate_1_9_1 | 2009 May 22 |
| fireEvent | fe_tp1_panel_testdate_1_9_1 | change |
| selectByIndex | fe_tp1_test_value_1_9_1_1 | 0 |
| fireEvent | fe_tp1_test_value_1_9_1_1 | change |
| selectByIndex | fe_tp1_test_value_1_9_1_2 | 1 |
| fireEvent | fe_tp1_test_value_1_9_1_2 | change |

# Short blood pressure panel
| type | fe_tp1_panel_testdate_1_1_1 | 2009 May 22 |
| fireEvent | fe_tp1_panel_testdate_1_1_1 | change |
| type | fe_tp1_test_value_1_1_1_1 | 110 |
| fireEvent | fe_tp1_test_value_1_1_1_1 | change |
| type | fe_tp1_test_value_1_1_1_2 | 70 |
| fireEvent | fe_tp1_test_value_1_1_1_2 | change |

# Weight & Height tracking panel
| click | fe_tp1_panel_opt_button_1_2_1_1 |
| type | fe_tp1_test_value_1_2_1_1 | 144 |
| fireEvent | fe_tp1_test_value_1_2_1_1 | change |
| type | fe_tp1_test_value_1_2_1_3 | 56 |
| fireEvent | fe_tp1_test_value_1_2_1_3 | change |
| assertValue | fe_tp1_test_value_1_2_1_4 | 32.28 |
| type | fe_tp1_test_unit_1_2_1_1 | kilograms |
| fireEvent | fe_tp1_test_unit_1_2_1_1 | change |
| fireEvent | fe_tp1_test_unit_1_2_1_1 | blur |
| waitForValue | fe_tp1_test_value_1_2_1_4 | 71.17 |
| type | fe_tp1_test_unit_1_2_1_3 | centimeters |
| fireEvent | fe_tp1_test_unit_1_2_1_3 | change |
| assertValue | fe_tp1_test_value_1_2_1_4 | 459.18 |
| type | fe_tp1_test_value_1_2_1_1 |
| fireEvent | fe_tp1_test_value_1_2_1_1 | change |
| assertValue | fe_tp1_test_value_1_2_1_4 |
| type | fe_tp1_test_value_1_2_1_1 | 144 |
| fireEvent | fe_tp1_test_value_1_2_1_1 | change |
| type | fe_tp1_test_unit_1_2_1_1 | pounds |
| fireEvent | fe_tp1_test_unit_1_2_1_1 | change |
| type | fe_tp1_test_unit_1_2_1_3 | inches |
| fireEvent | fe_tp1_test_unit_1_2_1_3 | change |
| assertValue | fe_tp1_test_value_1_2_1_4 | 32.28 |

# Lipid (Cholesterol) panel in Serum or Plasma
| type | fe_tp1_panel_testdate_1_3_1 | 2009 May 22 |
| fireEvent | fe_tp1_panel_testdate_1_3_1 | change |
| type | fe_tp1_test_value_1_3_1_1 | 180 |
| fireEvent | fe_tp1_test_value_1_3_1_1 | change |
| type | fe_tp1_test_value_1_3_1_2 | 160 |
| fireEvent | fe_tp1_test_value_1_3_1_2 | change |

| click | fe_reminders_1_1 |
# wait for the lastPopupWindow_ variable to be filled in before we take the
# window down.
| waitForExpression | javascript{testWindow_.Def.lastPopupWindow_ != null;} | true |
# Test that the popup window does not close via control-C
| controlKeyDown |
| keyPress | dom=Def.lastPopupWindow_ | \67 |
| controlKeyUp |
| verifyExpression | javascript{testWindow_.Def.lastPopupWindow_.closed} | false |
# Test that hitting another key does close the popup window.
| keyUp | dom=Def.lastPopupWindow_ | \68 |
| waitForExpression | javascript{testWindow_.Def.lastPopupWindow_.closed} | true |
| type | fe_birth_date | 1989 |
| fireEvent | fe_birth_date | change |
| waitForExpression | javascript{testWindow_.$("fe_reminders_1_1").messageManager.getAllMessages().join("").indexOf("age of 0.5 and 19 unless they are allergic")==-1;} | true |
# Show reminder rules with or without hard to reading characters
| open | /rules |
| fireEvent | fe_rule_type | focus |
| waitForExpression | javascript{testWindow_.$('completionOptions').down().childNodes.length} | 3 |
| selectByIndex | fe_rule_type | 2 |
| waitForValue | fe_rule_type | Reminder Rule |
| click | view_all_in_readable_format |
| waitForExpression  | javascript{testWindow_.location.href} | */show_in_readable_format |
| waitForExpression | javascript{testWindow_.document.documentElement.textContent.indexOf("Exclusion Criteria") > 0} | true |

# Go back to the phr home page and remove the profile so it doesn't get in the
# way of profiles in other tests for this user
| open | /phr_home |
| waitForExpression | javascript{testWindow_.location.href} | */phr_home |
| waitForVisible | wedgie_1 |

| click | wedgie_1 |
| waitForExpression | javascript{testWindow_.$('wedgie_1').hasClassName('sprite_icons-phr-hide-all-orange')} | true |
| waitForVisible | links_cell_1_1 |
| click | remove_profile_1 |
